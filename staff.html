<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add / Edit Staff</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="header">
  <h1>Add / Edit Staff</h1>
</div>

<div class="nav">
  <a href="dashboard.html">Dashboard</a>
  <a href="#" onclick="logout()">Log out</a>
</div>

<div class="main">
  <div id="staffList">Loading staffâ€¦</div>
</div>

<script>
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");

if (!token || role !== "management") {
  window.location.href = "login.html";
}

// Fetch and render staff
async function loadStaff() {
  const res = await fetch(
    "https://nhs-staff-portal.onrender.com/staff",
    {
      headers: {
        "Authorization": token
      }
    }
  );

  if (!res.ok) {
    document.getElementById("staffList").innerText =
      "Unable to load staff list.";
    return;
  }

  const staff = await res.json();

  const container = document.getElementById("staffList");
  container.innerHTML = "";

  staff.forEach(user => {
    const div = document.createElement("div");
    div.style.marginBottom = "30px";
    div.style.borderBottom = "1px solid #ccc";
    div.style.paddingBottom = "20px";

    div.innerHTML = `
      <h3>${user.username || user.email}</h3>

      <label>Role:</label><br>
      <select id="role-${user.id}">
        <option value="clinical" ${user.role === "clinical" ? "selected" : ""}>Clinical</option>
        <option value="management" ${user.role === "management" ? "selected" : ""}>Management</option>
      </select>
      <br><br>

      <button class="button" onclick="saveRole('${user.id}')">
        Save
      </button>
    `;

    container.appendChild(div);
  });
}

// Save role update
async function saveRole(userId) {
  const newRole = document.getElementById(`role-${userId}`).value;

  const res = await fetch(
    `https://nhs-staff-portal.onrender.com/staff/${userId}`,
    {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": token
      },
      body: JSON.stringify({ role: newRole })
    }
  );

  if (res.ok) {
    alert("Role updated");
  } else {
    alert("Failed to update role");
  }
}

function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}

loadStaff();
</script>

</body>
</html>
